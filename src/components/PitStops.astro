---
import globalJsdom from "global-jsdom";
import { select } from "d3-selection";
import { csv } from "d3-fetch";
import { min, max, group } from "d3-array";

globalJsdom("<html><head></head><body></body></html>", {});

const width = 800;
const height = 500;
const margin = { top: 20, right: 20, bottom: 20, left: 20 };

const pitstops = await csv("http://localhost:3000/data/pit_stops.csv");
const races = group((await csv("http://localhost:3000/data/races.csv")), d => String(d.raceId));
const drivers = group((await csv("http://localhost:3000/data/drivers.csv")), d => String(d.driverId));
const results = group((await csv("http://localhost:3000/data/results.csv")), d => String(d.raceId), d => String(d.driverId));
const constructors = group((await csv("http://localhost:3000/data/constructors.csv")), d => String(d.constructorId));

const getRace = (raceId: string) => races.get(raceId)[0];
const getDriver = (driverId: string) => drivers.get(driverId)[0];
const getContructor = (raceId: string, driverId: string) => constructors.get(results.get(raceId)?.get(driverId)[0].constructorId)[0];

const data = pitstops.map(d => {
    const race = getRace(String(d.raceId));
    const driver = getDriver(String(d.driverId));
    const constructor = getContructor(String(d.raceId), String(d.driverId));

    return {
        y: Number(d.milliseconds),
        x: race?.date,
        race,
        driver,
        constructor
    }
});

console.log(data);

const minX = min(data, (d) => d.x);
const maxX = max(data, (d) => d.x);
const minY = min(data, (d) => d.y);
const maxY = max(data, (d) => d.y);

const svg = select("body").append("svg");
const chart = svg.append("g").classed("chart", true);
const xAxis = chart.append("g").classed("axis x", true);
const yAxis = chart.append("g").classed("axis y", true);
const plot = chart.append("g").classed("plot", true);

// Update viewbox
svg
  .attr("viewBox", `0 0 ${width} ${height}`)
  .select("g")
  .attr("transform", `translate(${margin.left},${margin.top})`);

const el = svg.node()?.outerHTML;

// console.log(el, data, minX, maxX, minY, maxY);

---

<div set:html={el} />
